# Cairn Task Data Documentation

## Overview

This document explains how task data is fetched, stored, and managed in the Cairn agent management system. It covers the data formats, API endpoints, and database interactions used for task management.

## Database Structure

Task data is stored in an SQLite database (`cairn_tasks.db`) with the following main tables:

1. **active_tasks** - Stores information about all active tasks
   - `task_id` (TEXT PRIMARY KEY) - Unique identifier for the task
   - `payload` (TEXT) - JSON string containing task details and state
   - `run_id` (TEXT) - Identifier for the task run
   - `run_ids` (TEXT) - Related run IDs (comma-separated)
   - `created_at` (TIMESTAMP)
   - `updated_at` (TIMESTAMP)
   - `agent_type` (TEXT) - Type of agent (Fullstack Planner, PM, SWE)
   - `agent_status` (TEXT) - Current status (Running, Completed, Failed, Queued)
   - `agent_output` (TEXT) - JSON output from the agent
   - `related_run_ids` (TEXT) - IDs of related tasks
   - `sibling_subtask_ids` (TEXT) - IDs of sibling subtasks
   - `parent_fullstack_id` (TEXT) - ID of parent Fullstack Planner task
   - `subtask_index` (INTEGER) - Index of subtask within parent task

2. **task_logs** - Stores logs generated by tasks
   - `log_id` (INTEGER PRIMARY KEY)
   - `run_id` (TEXT) - ID of the associated task
   - `agent_type` (TEXT) - Type of agent that generated the log
   - `log_data` (TEXT) - JSON string containing log data
   - `created_at` (TIMESTAMP)
   - `updated_at` (TIMESTAMP)

3. **debug_messages** - Stores system debug messages
   - `message_id` (INTEGER PRIMARY KEY)
   - `message` (TEXT) - Debug message content
   - `timestamp` (TIMESTAMP)

## Task Data Format

Task data is stored as JSON in the `payload` field of the `active_tasks` table. The payload structure varies by agent type but generally includes:

### Common Fields for All Tasks
```json
{
  "run_id": "unique-task-identifier",
  "created_at": "2023-06-01 12:00:00",
  "updated_at": "2023-06-01 12:30:00",
  "description": "Task description text",
  "agent_status": "Running|Completed|Failed|Queued",
  "agent_type": "Fullstack Planner|PM|SWE",
  "agent_output": {},
  "model_provider": "anthropic|openai",
  "model_name": "claude-3-7-sonnet-latest|gpt-4o"
}
```

### Fullstack Planner Specific Fields
```json
{
  "repos": ["repo1", "repo2"],
  "agent_output": {
    "list_of_subtasks": ["Subtask 1 description", "Subtask 2 description"],
    "list_of_subtask_titles": ["Subtask 1 title", "Subtask 2 title"],
    "list_of_subtask_repos": ["repo1", "repo2"],
    "assessment_of_subtask_difficulty": ["Easy", "Medium"],
    "assessment_of_subtask_assignment": ["agent", "agent"]
  }
}
```

### PM/SWE Specific Fields
```json
{
  "repo": "repo-name",
  "branch": "feature/branch-name",
  "parent_fullstack_id": "parent-task-id",
  "subtask_index": 0,
  "related_run_ids": ["related-task-1", "related-task-2"],
  "sibling_subtask_ids": ["sibling-task-1", "sibling-task-2"],
  "agent_output": {
    "pr_url": "https://github.com/owner/repo/pull/123"
  }
}
```

## API Endpoints for Task Data

### Fetching Task Data

1. **Get All Active Tasks**
   - Endpoint: `GET /active-tasks`
   - Response: Array of task objects with parsed JSON payloads
   - Example:
   ```javascript
   fetch('/active-tasks')
     .then(response => response.json())
     .then(tasks => console.log(tasks));
   ```

2. **Get Task Logs**
   - Endpoint: `GET /task-logs/{run_id}`
   - Response: Array of log objects for the specified task
   - Example:
   ```javascript
   fetch(`/task-logs/${taskId}`)
     .then(response => response.json())
     .then(logs => console.log(logs));
   ```

### Task Management

1. **Kickoff a New Agent**
   - Endpoint: `POST /kickoff-agent`
   - Request Body:
   ```json
   {
     "agent_type": "Fullstack Planner|PM|SWE",
     "payload": {
       "description": "Task description",
       "model_provider": "anthropic",
       "model_name": "claude-3-7-sonnet-latest",
       "repos": ["repo1", "repo2"]  // For Fullstack Planner
       // OR
       "repo": "repo-name",  // For PM/SWE
       "branch": "feature/branch-name"  // Optional
     }
   }
   ```
   - Response: Object with run_id, agent_type, status, and message

2. **Create Subtasks from Fullstack Planner**
   - Endpoint: `POST /create-subtasks`
   - Request Body:
   ```json
   {
     "fullstack_planner_run_id": "parent-task-id",
     "subtask_index": 0  // Optional - if provided, creates only this subtask
   }
   ```
   - Response: Object with created_tasks array, message, and fullstack_planner_run_id

3. **Delete a Task**
   - Endpoint: `DELETE /active-tasks/{task_id}`
   - Response: Success message

## Task Data Flow

1. **Task Creation**:
   - User submits task details via the UI
   - `/kickoff-agent` endpoint receives the request
   - WorkerManager creates a task with a unique ID
   - Task is stored in the database
   - Worker process is started to execute the task

2. **Task Execution**:
   - Worker process updates task status in the database
   - Worker logs execution details to the task_logs table
   - UI periodically polls `/active-tasks` to show updated status

3. **Subtask Creation** (for Fullstack Planner):
   - Fullstack Planner completes and generates subtask definitions
   - User triggers subtask creation via UI
   - `/create-subtasks` endpoint processes the request
   - PM tasks are created for each subtask with references to parent task
   - Subtasks appear in UI with parent-child relationship

4. **Task Completion**:
   - Worker process updates task status to "Completed"
   - Final output is stored in agent_output field
   - For PM tasks, PR URL may be included in agent_output

## Task Relationships

Tasks can have various relationships:

1. **Parent-Child**: Fullstack Planner tasks can have PM subtasks
   - Child tasks reference parent via `parent_fullstack_id`
   - Parent task can access children via their `task_id`s

2. **Siblings**: PM tasks created from the same Fullstack Planner
   - Sibling tasks reference each other via `sibling_subtask_ids`

3. **Related**: Tasks can reference other related tasks
   - Related tasks are linked via `related_run_ids`

## UI Task Display

The UI organizes tasks hierarchically:

1. Parent tasks (Fullstack Planner) show:
   - Task ID and description
   - Status badge
   - Number of subtasks
   - Model provider and name
   - Payload details (expandable)
   - PR links from child tasks

2. Child tasks (PM) show:
   - Task ID and description
   - Status badge
   - Parent task reference
   - Repository name
   - PR link if available

## Task Status Lifecycle

1. **Queued**: Task is created but not yet running
2. **Running**: Task is currently executing
3. **Completed**: Task has finished successfully
4. **Failed**: Task encountered an error and could not complete

## Debug Messages

System debug messages are stored in the `debug_messages` table and can be viewed via:
- Endpoint: `GET /debug-messages?limit=20`
- Response: Array of debug message objects with message and timestamp
